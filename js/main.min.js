// history reset
if (window.history.replaceState) {
  window.history.replaceState(null, null, window.location.href);
}

// scroll top
$(window).scroll(function () {
  var height = $(window).scrollTop();
  if (height > 100) {
    $('#top').fadeIn();
  } else {
    $('#top').fadeOut();
  }
});

// main
$(document).ready(function () {
  // sidebar menu
  var url = window.location;
  $('ul.sidebar-menu a').filter(function () {
    return this.href == url;
  })
    .parent().addClass('active');
  $('ul.treeview-menu a').filter(function () {
    return this.href == url;
  })
    .parentsUntil('.sidebar-menu > .treeview-menu').addClass('active');

  // remove 'hide_item' class
  document.onload = $('#hide_item').removeClass('hide-item');

  // scroll top
  $("#top").click(function (event) {
    event.preventDefault();
    $("html, body").animate({ scrollTop: 0 }, "slow");
    return false;
  });

  // datatables
  // search mark
  $.extend(true, $.fn.dataTable.defaults, {
    mark: true
  });

  // group table
  $('#table_groups').DataTable({
    mark: true,
    'dom': "<'row'<'col-sm-6'f><'col-sm-6'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
    'columnDefs': [
      { 'width': '25%', 'targets': 0 },
      { 'width': '25%', 'targets': 1 },
      { 'width': '25%', 'targets': 2 },
      { 'width': '25%', 'targets': 3 }
    ],
    'order': [[0, 'asc']]
  });

  // users table
  $('#table_users').DataTable({
    mark: true,
    'dom': "<'row'<'col-sm-6'f><'col-sm-6'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
    'columnDefs': [
      { 'width': '20%', 'targets': 0 },
      { 'width': '20%', 'targets': 1 },
      { 'width': '20%', 'targets': 2 },
      { 'width': '20%', 'targets': 3 },
      { 'width': '20%', 'targets': 4 }
    ],
    'order': [[0, 'asc']]
  });

  // users am tl table
  $('#table_users_am_tl').DataTable({
    mark: true,
    'dom': "<'row'<'col-sm-6'f><'col-sm-6'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
    'columnDefs': [
      { 'width': '25%', 'targets': 0 },
      { 'width': '25%', 'targets': 1 },
      { 'width': '25%', 'targets': 2 },
      { 'width': '25%', 'targets': 3 }
    ],
    'order': [[0, 'asc']]
  });

  // teams table
  $('#table_teams').DataTable({
    mark: true,
    'dom': "<'row'<'col-sm-6'f><'col-sm-6'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
    'columnDefs': [
      { 'width': '20%', 'targets': 0 },
      { 'width': '20%', 'targets': 1 },
      { 'width': '20%', 'targets': 2 },
      { 'width': '20%', 'targets': 3 },
      { 'width': '20%', 'targets': 4 }
    ],
    'order': [[0, 'asc']]
  });

  // teams tl table
  $('#table_teams_tl').DataTable({
    mark: true,
    'dom': "<'row'<'col-sm-6'f><'col-sm-6'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
    'columnDefs': [
      { 'width': '25%', 'targets': 0 },
      { 'width': '25%', 'targets': 1 },
      { 'width': '25%', 'targets': 2 },
      { 'width': '25%', 'targets': 3 }
    ],
    'order': [[0, 'asc']]
  });

  // employees table
  $('#table_employees').DataTable({
    mark: true,
    'dom': "<'row'<'col-sm-6'f><'col-sm-6'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
    'columnDefs': [
      { 'width': '25%', 'targets': 0 },
      { 'width': '25%', 'targets': 1 },
      { 'width': '25%', 'targets': 2 },
      { 'width': '25%', 'targets': 3 }
    ],
    'order': [[0, 'asc']]
  });

  // notifications table
  $('#table_notifications').DataTable({
    mark: true,
    'dom': "<'row'<'col-sm-6'f><'col-sm-6'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
    'columnDefs': [
      { 'width': '25%', 'targets': 0 },
      { 'width': '25%', 'targets': 1 },
      { 'width': '25%', 'targets': 2 },
      { 'width': '25%', 'targets': 3 }
    ],
    'order': [[0, 'asc']]
  });

  // event table
  $('#table_events').DataTable({
    mark: true,
    'dom': "<'row'<'col-sm-6'f><'col-sm-6'l>>" + "<'row'<'col-sm-12'tr>>" + "<'row'<'col-sm-5'i><'col-sm-7'p>>",
    'columnDefs': [
      { 'width': '6%', 'targets': 0 },
      { 'width': '23%', 'targets': 1 },
      { 'width': '23%', 'targets': 2 },
      { 'width': '23%', 'targets': 3 },
      { 'width': '23%', 'targets': 4 }
    ],
    'order': [[1, 'desc']]
  });

  // submit login
  $('#form_login').on('submit', function (event) {
    event.preventDefault();
    var login_class = document.getElementById('login_class');
    var form_data = $(this).serialize();
    $.ajax({
      url: 'includes/actions.php',
      method: 'POST',
      data: form_data,
      success: function (data) {
        if (data == '') {
          location.href = 'dashboard.php';
        } else {
          login_class.classList.add('has-error');
          $('#login_message').text(data);
          $('#user').val('');
        }
      }
    });
  });

  // add group
  $('#add_group').click(function () {
    clearUser();
    $('.title_group').text('Add Group');
    $('#action_group').val('insert');
    $('#form_group')[0].reset();
    $('#modal_group').modal('show');
  });

  // add user
  $('#add_user').click(function () {
    clearUser();
    $('.title_user').text('Add User');
    $('#action_user').val('insert');
    $('#form_user')[0].reset();
    $('.select2').select2();
    $('#modal_user').modal('show');
  });

  // add team
  $('#add_team').click(function () {
    clearTeam();
    $('.title_team').text('Add Team');
    $('#action_team').val('insert');
    $('#form_team')[0].reset();
    $('.select2').select2();
    $('#modal_team').modal('show');
  });

  // add employee
  $('#add_employee').click(function () {
    clearTeam();
    clearEmployee();
    $('.title_employee').text('Add Employee');
    $('#action_employee').val('insert');
    $('#form_employee')[0].reset();
    $('.select2').select2();
    $('#modal_employee').modal('show');
  });

  // new notification
  $('#new_notification').click(function () {
    clearNotification();
    $('.title_notification').text('New Notification');
    $('#action_notification').val('insert');
    $('#form_notification')[0].reset();
    $('.select2').select2();
    $('#modal_notification').modal('show');
  });

  // submit group
  $('#form_group').on('submit', function (event) {
    event.preventDefault();
    var name_group_class = document.getElementById('name_group_class');
    var form_data = $(this).serialize();
    $.ajax({
      url: 'includes/actions.php',
      method: 'POST',
      data: form_data,
      success: function (data) {
        if (data == '') {
          $('#modal_group').modal('hide');
          setTimeout(function () { window.location.reload(true); }, 200);
        } else {
          name_group_class.classList.add('has-error');
          $('#name_group_message').text(data);
        }
      }
    });
  });

  // submit user
  $('#form_user').on('submit', function (event) {
    event.preventDefault();
    var barcode_user_class = document.getElementById('barcode_user_class');
    var form_data = $(this).serialize();
    $.ajax({
      url: 'includes/actions.php',
      method: 'POST',
      data: form_data,
      success: function (data) {
        if (data == '') {
          $('#modal_user').modal('hide');
          setTimeout(function () { window.location.reload(true); }, 200);
        } else {
          barcode_user_class.classList.add('has-error');
          $('#barcode_user_message').text(data);
        }
      }
    });
  });

  // submit team
  $('#form_team').on('submit', function (event) {
    event.preventDefault();
    var name_team_class = document.getElementById('name_team_class');
    var form_data = $(this).serialize();
    $.ajax({
      url: 'includes/actions.php',
      method: 'POST',
      data: form_data,
      success: function (data) {
        if (data == '') {
          $('#modal_team').modal('hide');
          setTimeout(function () { window.location.reload(true); }, 200);
        } else {
          name_team_class.classList.add('has-error');
          $('#name_team_message').text(data);
        }
      }
    });
  });

  // submit employee
  $('#form_employee').on('submit', function (event) {
    event.preventDefault();
    var barcode_employee_class = document.getElementById('barcode_employee_class');
    var form_data = $(this).serialize();
    $.ajax({
      url: 'includes/actions.php',
      method: 'POST',
      data: form_data,
      success: function (data) {
        if (data == '') {
          $('#modal_employee').modal('hide');
          setTimeout(function () { window.location.reload(true); }, 200);
        } else {
          barcode_employee_class.classList.add('has-error');
          $('#barcode_employee_message').text(data);
        }
      }
    });
  });

  // submit send notification
  $('#form_notification').on('submit', function (event) {
    clearNotification();
    event.preventDefault();
    var team_class = document.getElementById('team_class');
    var employee_class = document.getElementById('employee_class');
    var text_class = document.getElementById('text_class');
    var form_data = $(this).serialize();
    $.ajax({
      url: 'includes/actions.php',
      method: 'POST',
      data: form_data,
      success: function (data) {
        if (data == 'null') {
          $('#modal_notification').modal('hide');
          setTimeout(function () { window.location.reload(true); }, 200);
        } else {
          var json = JSON.parse(data);
          if (typeof json.team_employee_message != 'undefined') {
            team_class.classList.add('has-error');
            employee_class.classList.add('has-error');
            $('#team_employee_message').text(json.team_employee_message);
          }
          if (typeof json.text_message != 'undefined') {
            text_class.classList.add('has-error');
            $('#text_message').text(json.text_message);
          }
        }
      }
    });
  });

  // edit group, user, team, employee, notifications
  $(document).on('click', '.edit', function () {
    clearUser();
    var type = document.getElementById('type').value;
    var id = $(this).attr('id');
    var action_fetch = 'fetch';
    $.ajax({
      url: 'includes/actions.php',
      method: 'POST',
      data: { type: type, id: id, action_fetch: action_fetch },
      dataType: 'json',
      success: function (data) {
        if (type == 'groups') {
          $('.title_group').text('Edit Group');
          $('#id_edit_group').val(id);
          $('#name_group').val(data.name);
          $('#comment_group').val(data.comment);
          $('#name_edit_group').val(data.name);
          $('#action_group').val('update');
          $('#modal_group').modal('show');
        } else if (type == 'users') {
          $('.title_user').text('Edit User');
          $('#id_edit_user').val(id);
          $('#barcode_user').val(data.barcode);
          $("#role_user").select2().val(data.role).trigger("change");
          $("#group_user").select2().val(data.id_group).trigger("change")
          $('#comment_user').val(data.comment);
          $('#barcode_edit_user').val(data.barcode);
          $('#action_user').val('update');
          $('#modal_user').modal('show');
        } else if (type == 'teams') {
          $('.title_team').text('Edit Team');
          $('#id_edit_team').val(id);
          $('#name_team').val(data.name);
          $("#owner_team").select2().val(data.id_owner).trigger("change");
          $('#comment_team').val(data.comment);
          $('#name_edit_team').val(data.name);
          $('#action_team').val('update');
          $('#modal_team').modal('show');
        } else if (type == 'employees') {
          $('.title_employee').text('Edit Employee');
          $('#id_edit_employee').val(id);
          $('#barcode_employee').val(data.barcode);
          $("#team_employee").select2().val(data.id_team).trigger("change");
          $('#comment_employee').val(data.comment);
          $('#barcode_edit_employee').val(data.barcode);
          $('#action_employee').val('update');
          $('#modal_employee').modal('show');
        }
      }
    });
  });

  // clear user barcode output
  function clearUser() {
    var barcode_user_class = document.getElementById('barcode_user_class');
    barcode_user_class.classList.remove('has-error');
    $('#barcode_user_message').text('');
  }

  // clear team name output
  function clearTeam() {
    var name_team_class = document.getElementById('name_team_class');
    name_team_class.classList.remove('has-error');
    $('#name_team_message').text('');
  }

  // clear employee barcode output
  function clearEmployee() {
    var barcode_employee_class = document.getElementById('barcode_employee_class');
    barcode_employee_class.classList.remove('has-error');
    $('#barcode_employee_message').text('');
  }

  // clear notification team, employee, text output
  function clearNotification() {
    var team_class = document.getElementById('team_class');
    var employee_class = document.getElementById('employee_class');
    var text_class = document.getElementById('text_class');
    team_class.classList.remove('has-error');
    employee_class.classList.remove('has-error');
    text_class.classList.remove('has-error');
    $('#team_employee_message').text('');
    $('#text_message').text('');
  }

  // delete group, user, team, employee, notifications
  $(document).on('click', '.delete', function () {
    var type = document.getElementById('type').value;
    var id = $(this).attr('id');
    if (type == 'groups') {
      $('.title_delete').text('Delete Group');
    } else if (type == 'users') {
      $('.title_delete').text('Delete User');
    } else if (type == 'teams') {
      $('.title_delete').text('Delete Team');
    } else if (type == 'employees') {
      $('.title_delete').text('Delete Employee');
    } else if (type == 'notifications') {
      $('.title_delete').text('Delete Notification');
    }
    $('#type_delete').val(type);
    $('#id_delete').val(id);
    $('#action_delete').val('delete');
    $('#modal_delete').modal('show');
  });

  // submit delete group, user, team, employee, notifications
  $('#form_delete').on('submit', function (event) {
    event.preventDefault();
    var form_data = $(this).serialize();
    $.ajax({
      url: 'includes/actions.php',
      method: 'POST',
      data: form_data,
      success: function () {
        $('#modal_delete').modal('hide');
        setTimeout(function () { window.location.reload(true); }, 200);
      }
    });
  });

  // disable Enter keypress
  window.addEventListener('keydown', function (e) { if (e.keyIdentifier == 'U+000A' || e.keyIdentifier == 'Enter' || e.keyCode == 13) { if (e.target.nodeName == 'INPUT' && e.target.type == 'text') { e.preventDefault(); return false; } } }, true);
})